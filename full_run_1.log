
======================================
SETUP
======================================

[14:27:27] Using base URL: http://localhost:8000
[14:27:27] Waiting for: orchestrator health endpoint (timeout 60s)
[0;32m[14:27:32] âœ“ Condition met after 0s[0m
[0;32m[14:27:38] âœ“ Health endpoint reports healthy (expected=healthy, actual=healthy)[0m

======================================
STAGE 0: INFRASTRUCTURE
======================================

[14:27:38] Running test: infra_containers
[0;32m[14:27:38] âœ“ Container vib-orchestrator running (expected=true, actual=true)[0m
[0;32m[14:27:39] âœ“ Container vib-worker running (expected=true, actual=true)[0m
[0;32m[14:27:39] âœ“ Container vib-beat running (expected=true, actual=true)[0m
[0;32m[14:27:40] âœ“ Container vib-postgres running (expected=true, actual=true)[0m
[0;32m[14:27:41] âœ“ Container vib-redis running (expected=true, actual=true)[0m
[0;32m[14:27:41] âœ“ Container vib-qdrant running (expected=true, actual=true)[0m
[0;32m[14:27:41] âœ“ infra_containers passed (3s)[0m
[14:27:41] Running test: infra_health_status
[0;32m[14:27:48] âœ“ Health endpoint returns 200[0m
[0;32m[14:27:49] âœ“ Health status is healthy (expected=healthy, actual=healthy)[0m
[0;32m[14:27:49] âœ“ infra_health_status passed (8s)[0m
[14:27:49] Running test: infra_health_services
[0;32m[14:27:49] âœ“ Service postgres healthy (expected=ok, actual=ok)[0m
[0;32m[14:27:49] âœ“ Service redis healthy (expected=ok, actual=ok)[0m
[0;32m[14:27:49] âœ“ Service qdrant healthy (expected=ok, actual=ok)[0m
[0;32m[14:27:49] âœ“ Service celery_worker healthy (expected=ok, actual=ok)[0m
[0;32m[14:27:49] âœ“ infra_health_services passed (0s)[0m
[14:27:49] Running test: infra_metrics_endpoint
[0;32m[14:27:49] âœ“ Metrics endpoint returns 200[0m
[0;32m[14:27:49] âœ“ Metrics contain HELP blocks[0m
[0;32m[14:27:49] âœ“ infra_metrics_endpoint passed (0s)[0m
[14:27:49] Running test: infra_metrics_help
[0;32m[14:27:49] âœ“ api_request_duration_seconds metric present[0m
[0;32m[14:27:49] âœ“ infra_metrics_help passed (0s)[0m
[14:27:49] Running test: infra_database
[0;32m[14:27:50] âœ“ Database responds (expected=1, actual=1)[0m
[0;32m[14:27:50] âœ“ infra_database passed (1s)[0m
[14:27:50] Running test: infra_redis
[0;32m[14:27:51] âœ“ Redis responds (expected=PONG, actual=PONG)[0m
[0;32m[14:27:51] âœ“ infra_redis passed (1s)[0m
[14:27:51] Running test: infra_qdrant
[0;32m[14:27:51] âœ“ Qdrant collection available[0m
[0;32m[14:27:51] âœ“ infra_qdrant passed (0s)[0m
[14:27:51] Running test: infra_auth_valid
[0;32m[14:27:51] âœ“ Valid token accepted[0m
[0;32m[14:27:51] âœ“ infra_auth_valid passed (0s)[0m
[14:27:51] Running test: infra_auth_invalid
[0;32m[14:27:51] âœ“ Invalid token rejected[0m
[0;32m[14:27:51] âœ“ infra_auth_invalid passed (0s)[0m
[14:27:51] Running test: infra_auth_missing
[0;32m[14:27:51] âœ“ Missing token rejected[0m
[0;32m[14:27:51] âœ“ infra_auth_missing passed (0s)[0m
[14:27:51] Running test: infra_rate_limit
[0;32m[14:27:54] âœ“ Rate limit triggered (2/32 responses were rate-limited)[0m
[0;32m[14:27:54] âœ“ infra_rate_limit passed (3s)[0m
[14:27:54] Running test: infra_rate_limit_reset
[14:27:54] Waiting 65s for rate limit window to reset
[0;32m[14:29:00] âœ“ Requests succeed after window reset (expected=200, actual=200)[0m
[0;32m[14:29:00] âœ“ infra_rate_limit_reset passed (66s)[0m
[14:29:00] Running test: infra_logs
[0;32m[14:29:00] âœ“ Logs contain timestamp[0m
[0;32m[14:29:00] âœ“ Logs contain endpoint/event[0m
[0;32m[14:29:00] âœ“ infra_logs passed (0s)[0m
[14:29:00] Running test: infra_metrics_increment
[0;32m[14:29:00] âœ“ Metrics updated after request[0m
[0;32m[14:29:00] âœ“ infra_metrics_increment passed (0s)[0m
[14:29:00] Running test: infra_cors
[0;32m[14:29:06] âœ“ CORS header present[0m
[0;32m[14:29:06] âœ“ infra_cors passed (6s)[0m
[14:29:06] Running test: infra_tls
[1;33m[14:29:06] âš  BASE_URL not HTTPS; skipping TLS check[0m
[0;32m[14:29:06] âœ“ infra_tls passed (0s)[0m
[14:29:06] Running test: infra_celery_worker
[0;32m[14:29:19] âœ“ Celery worker responding[0m
[0;32m[14:29:19] âœ“ infra_celery_worker passed (13s)[0m
[14:29:19] Running test: infra_celery_beat
[0;32m[14:29:19] âœ“ Celery beat running[0m
[0;32m[14:29:19] âœ“ infra_celery_beat passed (0s)[0m
[14:29:19] Running test: infra_db_schema
[0;32m[14:29:20] âœ“ DB schema migrated (23 > 10)[0m
[0;32m[14:29:20] âœ“ infra_db_schema passed (1s)[0m
[14:29:20] Running test: infra_metrics_prom
[0;32m[14:29:20] âœ“ Reminder lag histogram exposed[0m
[0;32m[14:29:20] âœ“ infra_metrics_prom passed (0s)[0m
[14:29:20] Running test: infra_qdrant_metric
[0;32m[14:29:20] âœ“ Qdrant gauge exported[0m
[0;32m[14:29:20] âœ“ infra_qdrant_metric passed (0s)[0m

======================================
STAGE 1: NOTES + VECTOR SEARCH
======================================

[14:29:20] Running test: notes_api_create
[0;32m[14:29:21] âœ“ Note created via API[0m
[0;32m[14:29:21] âœ“ notes_api_create passed (1s)[0m
[14:29:21] Running test: notes_db_record
[0;32m[14:29:21] âœ“ Note persisted in DB (expected=1, actual=1)[0m
[0;32m[14:29:21] âœ“ notes_db_record passed (0s)[0m
[14:29:21] Running test: notes_markdown
[0;32m[14:29:21] âœ“ Markdown file created[0m
[0;32m[14:29:21] âœ“ notes_markdown passed (0s)[0m
[14:29:21] Running test: notes_frontmatter
[0;32m[14:29:22] âœ“ Frontmatter has title[0m
[0;32m[14:29:22] âœ“ Frontmatter has tags[0m
[0;32m[14:29:22] âœ“ notes_frontmatter passed (1s)[0m
[14:29:22] Running test: notes_embedding
[14:29:22] Waiting for: note embedding state (timeout 90s)
[0;32m[14:29:22] âœ“ Condition met after 0s[0m
[0;32m[14:29:22] âœ“ notes_embedding passed (0s)[0m
[14:29:22] Running test: notes_vector_keyword
[0;32m[14:29:38] âœ“ Keyword search finds note[0m
[0;32m[14:29:38] âœ“ notes_vector_keyword passed (16s)[0m
[14:29:38] Running test: notes_vector_semantic
[0;32m[14:29:38] âœ“ Semantic search returns note[0m
[0;32m[14:29:38] âœ“ notes_vector_semantic passed (0s)[0m
[14:29:38] Running test: notes_top3
[0;32m[14:29:39] âœ“ Search returns <=3 results (3 < 4)[0m
[0;32m[14:29:39] âœ“ notes_top3 passed (1s)[0m
[14:29:39] Running test: notes_filter
[0;32m[14:29:39] âœ“ Search filter content_type=note yields results (10 > 0)[0m
[0;32m[14:29:39] âœ“ notes_filter passed (0s)[0m
[14:29:39] Running test: notes_user_scope
[0;32m[14:29:40] âœ“ Results scoped to user[0m
[0;32m[14:29:40] âœ“ notes_user_scope passed (1s)[0m
[14:29:40] Running test: notes_dedup_response
[0;32m[14:29:40] âœ“ Duplicate creation flagged (expected=true, actual=true)[0m
[0;32m[14:29:40] âœ“ notes_dedup_response passed (0s)[0m
[14:29:40] Running test: notes_dedup_message
[0;32m[14:29:40] âœ“ Deduplication message returned[0m
[0;32m[14:29:40] âœ“ notes_dedup_message passed (0s)[0m
[14:29:40] Running test: notes_db_constraint
[0;32m[14:29:41] âœ“ DB constraint blocked duplicate[0m
[0;32m[14:29:41] âœ“ notes_db_constraint passed (1s)[0m
[14:29:41] Running test: notes_slug_simple
[0;32m[14:29:42] âœ“ Slugified filename[0m
[0;32m[14:29:42] âœ“ notes_slug_simple passed (1s)[0m
[14:29:42] Running test: notes_slug_special
[0;32m[14:29:42] âœ“ Special chars sanitized[0m
[0;32m[14:29:42] âœ“ notes_slug_special passed (0s)[0m
[14:29:42] Running test: notes_slug_collision
[0;32m[14:29:42] âœ“ Slug collision resolved with suffix[0m
[0;32m[14:29:44] âœ“ notes_slug_collision passed (2s)[0m
[14:29:44] Running test: notes_file_sync
[0;32m[14:29:44] âœ“ file_sync_state entry exists (expected=1, actual=1)[0m
[0;32m[14:29:44] âœ“ notes_file_sync passed (0s)[0m
[14:29:44] Running test: notes_external_edit
[14:29:45] Waiting for: re-embedding after external edit (timeout 180s)
[0;31m[14:34:43] âœ— Timeout waiting for: re-embedding after external edit[0m
[0;32m[14:34:43] âœ“ Embedding timestamp advanced (1763130591.393027 > 1763130560.901533)[0m
[0;32m[14:34:44] âœ“ notes_external_edit passed (300s)[0m
[14:34:44] Running test: notes_chat_create
[0;32m[14:34:44] âœ“ Chat endpoint responded[0m
[0;32m[14:34:44] âœ“ Chat note mode returned (expected=note, actual=note)[0m
[0;32m[14:34:44] âœ“ Chat note ID present[0m
[0;32m[14:34:45] âœ“ notes_chat_create passed (1s)[0m
[14:34:45] Running test: notes_chat_search
[0;32m[14:34:50] âœ“ Chat search endpoint responded[0m
[0;32m[14:34:50] âœ“ Chat search mode returned (expected=search, actual=search)[0m
[0;32m[14:34:51] âœ“ Chat search returned results (5 > 0)[0m
[0;32m[14:34:51] âœ“ notes_chat_search passed (6s)[0m
[14:34:51] Running test: notes_list_endpoint
[0;32m[14:34:51] âœ“ List notes endpoint[0m
[0;32m[14:34:51] âœ“ notes_list_endpoint passed (0s)[0m
[14:34:51] Running test: notes_update_endpoint
[0;32m[14:34:51] âœ“ Patch note works[0m
[0;32m[14:34:51] âœ“ notes_update_endpoint passed (0s)[0m

======================================
STAGE 2: REMINDERS + NOTIFICATIONS
======================================

[14:34:51] Running test: reminder_api_create
[0;32m[14:34:51] âœ“ Reminder created via API[0m
[0;32m[14:34:51] âœ“ reminder_api_create passed (0s)[0m
[14:34:51] Running test: reminder_db_record
[0;32m[14:34:52] âœ“ Reminder persisted in DB (expected=1, actual=1)[0m
[0;32m[14:34:52] âœ“ reminder_db_record passed (1s)[0m
[14:34:52] Running test: reminder_scheduler_entry
[0;32m[14:34:53] âœ“ Reminder dc2a6324-4ed4-4b81-95a0-c64e83175dfd scheduled in APScheduler[0m
[0;32m[14:34:53] âœ“ reminder_scheduler_entry passed (1s)[0m
[14:34:53] Running test: reminder_chat_flow
[0;32m[14:34:54] âœ“ Chat endpoint accepted reminder request[0m
[0;32m[14:34:54] âœ“ reminder_chat_flow passed (1s)[0m
[14:34:54] Running test: reminder_smart_defaults
[0;32m[14:34:54] âœ“ Chat request for smart defaults[0m
[0;32m[14:35:00] âœ“ Reminder created via chat[0m
[0;32m[14:35:00] âœ“ Smart default produced local time 09:00:00[0m
[0;32m[14:35:00] âœ“ reminder_smart_defaults passed (6s)[0m
[14:35:00] Running test: reminder_dedup_response
[0;32m[14:35:01] âœ“ Duplicate reminder flagged (expected=true, actual=true)[0m
[0;32m[14:35:01] âœ“ reminder_dedup_response passed (1s)[0m
[14:35:01] Running test: reminder_dedup_constraint
[0;32m[14:35:01] âœ“ Database prevented duplicate reminder[0m
[0;32m[14:35:01] âœ“ reminder_dedup_constraint passed (0s)[0m
[14:35:01] Running test: reminder_timezone
[0;32m[14:35:02] âœ“ Timezone stored correctly (expected=America/Los_Angeles, actual=America/Los_Angeles)[0m
[0;32m[14:35:02] âœ“ reminder_timezone passed (1s)[0m
[14:35:02] Running test: reminder_due_local
[0;32m[14:35:03] âœ“ due_at_local preserved (expected=15:04:00, actual=15:04:00)[0m
[0;32m[14:35:03] âœ“ reminder_due_local passed (1s)[0m
[14:35:03] Running test: reminder_snooze_updates
[0;32m[14:35:04] âœ“ Snooze returned due_at[0m
[0;32m[14:35:04] âœ“ reminder_snooze_updates passed (1s)[0m
[14:35:04] Running test: reminder_snooze_logs
[0;32m[14:35:05] âœ“ Snooze reschedule logged[0m
[0;32m[14:35:06] âœ“ reminder_snooze_logs passed (1s)[0m
[14:35:06] Running test: reminder_cancel_endpoint
[0;32m[14:35:06] âœ“ Cancel endpoint[0m
[0;32m[14:35:06] âœ“ reminder_cancel_endpoint passed (0s)[0m
[14:35:06] Running test: reminder_cancel_state
[1;33m[14:35:07] âš  Base reminder not cancelled; cancelling now[0m
[0;32m[14:35:07] âœ“ Reminder marked cancelled (expected=cancelled, actual=cancelled)[0m
[0;32m[14:35:07] âœ“ reminder_cancel_state passed (1s)[0m
[14:35:08] Running test: reminder_recurring_daily
[0;32m[14:35:08] âœ“ Daily recurrence saved (expected=FREQ=DAILY, actual=FREQ=DAILY)[0m
[0;32m[14:35:08] âœ“ reminder_recurring_daily passed (0s)[0m
[14:35:08] Running test: reminder_recurring_weekly
[0;32m[14:35:09] âœ“ Weekly recurrence saved (expected=FREQ=WEEKLY;BYDAY=MO, actual=FREQ=WEEKLY;BYDAY=MO)[0m
[0;32m[14:35:09] âœ“ reminder_recurring_weekly passed (1s)[0m
[14:35:09] Running test: reminder_recurring_monthly
[0;32m[14:35:10] âœ“ Monthly recurrence saved (expected=FREQ=MONTHLY;BYMONTHDAY=1, actual=FREQ=MONTHLY;BYMONTHDAY=1)[0m
[0;32m[14:35:10] âœ“ reminder_recurring_monthly passed (1s)[0m
[14:35:10] Running test: device_registration
[0;32m[14:35:11] âœ“ Device registered[0m
[0;32m[14:35:11] âœ“ device_registration passed (1s)[0m
[14:35:11] Running test: device_db_entry
[0;32m[14:35:11] âœ“ Device row exists (expected=1, actual=1)[0m
[0;32m[14:35:11] âœ“ device_db_entry passed (0s)[0m
[14:35:11] Running test: device_test_notification
[0;32m[14:35:11] âœ“ Test notification endpoint[0m
[0;32m[14:35:11] âœ“ device_test_notification passed (0s)[0m
[14:35:12] Running test: push_metrics
[1;33m[14:35:12] âš  Push delivery metrics have no samples[0m
[0;32m[14:35:12] âœ“ push_metrics passed (0s)[0m
[14:35:12] Running test: reminder_fire_slo
[14:35:12] Waiting for reminder cec54d90-8de0-44a7-9fbf-058a7c303001 to fire (up to 150s)
[14:35:12] Waiting for: notification delivery for cec54d90-8de0-44a7-9fbf-058a7c303001 (timeout 150s)
[0;32m[14:36:02] âœ“ Condition met after 30s[0m
[0;32m[14:36:03] âœ“ Reminder fire lag <5 s (1.059373 < 5)[0m
[0;32m[14:36:03] âœ“ reminder_fire_slo passed (51s)[0m
[14:36:03] Running test: notification_delivery_record
[0;32m[14:36:04] âœ“ Notification delivery recorded (expected=delivered, actual=delivered)[0m
[0;32m[14:36:04] âœ“ notification_delivery_record passed (1s)[0m
[14:36:04] Running test: reminder_metrics_created
[0;32m[14:36:04] âœ“ reminders_created_total increments (13 > 12)[0m
[0;32m[14:36:04] âœ“ reminder_metrics_created passed (0s)[0m
[14:36:04] Running test: reminder_metrics_deduped
[0;32m[14:36:05] âœ“ reminders_deduped_total increments (3 > 2)[0m
[0;32m[14:36:05] âœ“ reminder_metrics_deduped passed (1s)[0m
[14:36:05] Running test: reminder_metrics_fire_lag
[1;33m[14:36:05] âš  Reminder fire lag histogram has no samples[0m
[0;32m[14:36:05] âœ“ reminder_metrics_fire_lag passed (0s)[0m
[14:36:05] Running test: reminder_list_endpoint
[0;32m[14:36:05] âœ“ List reminders endpoint[0m
[0;32m[14:36:05] âœ“ reminder_list_endpoint passed (0s)[0m
[14:36:05] Running test: reminder_update_endpoint
[0;32m[14:36:06] âœ“ Reminder update endpoint[0m
[0;32m[14:36:06] âœ“ reminder_update_endpoint passed (1s)[0m
[14:36:06] Running test: reminder_restart_persistence
[14:36:11] Waiting for: health after orchestrator restart (timeout 60s)
curl: (52) Empty reply from server
curl: (52) Empty reply from server
[0;32m[14:36:19] âœ“ Condition met after 2s[0m
[0;32m[14:36:19] âœ“ Reminder still available post-restart (expected=c68d6750-7ecb-45d2-90ca-eababf4d083b, actual=c68d6750-7ecb-45d2-90ca-eababf4d083b)[0m
[0;32m[14:36:19] âœ“ reminder_restart_persistence passed (13s)[0m

======================================
STAGE 3: DOCUMENTS + RAG
======================================

[14:36:19] Running test: doc_upload
[14:36:27] Document ingestion request succeeded (document_id=8c159d9c-0816-4551-b50b-d38ae79af1f1 job_id=e9cc5ee2-3407-4e58-b6d8-bea8c575f44d)
[14:36:27] Waiting for: document ingestion completion (timeout 180s)
[0;32m[14:36:37] âœ“ Condition met after 8s[0m
[0;32m[14:36:37] âœ“ Document uploaded[0m
[0;32m[14:36:37] âœ“ doc_upload passed (18s)[0m
[14:36:37] Running test: doc_job_created
[0;32m[14:36:37] âœ“ Job created for document[0m
[0;32m[14:36:37] âœ“ doc_job_created passed (0s)[0m
[14:36:37] Running test: doc_job_completed
[0;32m[14:36:37] âœ“ Document job completed[0m
[0;32m[14:36:37] âœ“ doc_job_completed passed (0s)[0m
[14:36:37] Running test: doc_status_indexed
[0;32m[14:36:38] âœ“ Document status indexed (expected=indexed, actual=indexed)[0m
[0;32m[14:36:38] âœ“ doc_status_indexed passed (1s)[0m
[14:36:38] Running test: doc_chunks_created
[0;32m[14:36:39] âœ“ Chunks created (1 > 0)[0m
[0;32m[14:36:39] âœ“ doc_chunks_created passed (1s)[0m
[14:36:39] Running test: doc_chunk_ordinals
[0;32m[14:36:39] âœ“ Chunk ordinals sequential (expected=0, actual=0)[0m
[0;32m[14:36:39] âœ“ doc_chunk_ordinals passed (0s)[0m
[14:36:39] Running test: doc_chunk_tokens
[0;32m[14:36:40] âœ“ Chunk token counts recorded (1 > 0)[0m
[0;32m[14:36:40] âœ“ doc_chunk_tokens passed (1s)[0m
[14:36:40] Running test: doc_chunk_metadata
[0;32m[14:36:41] âœ“ Chunk metadata includes pages (1 > 0)[0m
[0;32m[14:36:41] âœ“ doc_chunk_metadata passed (1s)[0m
[14:36:41] Running test: doc_vectors
[0;32m[14:36:41] âœ“ Vectors exist for document (1 > 0)[0m
[0;32m[14:36:41] âœ“ doc_vectors passed (0s)[0m
[14:36:41] Running test: doc_vector_payload_fields
[0;32m[14:36:41] âœ“ Vector payload contains embedding_model[0m
[0;32m[14:36:41] âœ“ doc_vector_payload_fields passed (0s)[0m
[14:36:41] Running test: doc_search_keyword
[0;32m[14:36:46] âœ“ Keyword search HTTP 200[0m
[0;32m[14:36:46] âœ“ Keyword search finds document[0m
[0;32m[14:36:46] âœ“ doc_search_keyword passed (5s)[0m
[14:36:46] Running test: doc_search_semantic
[0;32m[14:36:47] âœ“ Semantic search HTTP 200[0m
[0;32m[14:36:47] âœ“ Semantic search returns document[0m
[0;32m[14:36:47] âœ“ doc_search_semantic passed (0s)[0m
[14:36:47] Running test: doc_search_filter
[0;32m[14:36:47] âœ“ Search filter HTTP 200[0m
[0;32m[14:36:47] âœ“ Search filter for document chunks (10 > 0)[0m
[0;32m[14:36:47] âœ“ doc_search_filter passed (0s)[0m
[14:36:47] Running test: doc_rag_answer
[0;32m[14:37:04] âœ“ RAG chat request[0m
[0;32m[14:37:04] âœ“ doc_rag_answer passed (17s)[0m
[14:37:04] Running test: doc_rag_citations
[0;32m[14:37:04] âœ“ RAG citations present (5 > 0)[0m
[0;32m[14:37:05] âœ“ doc_rag_citations passed (1s)[0m
[14:37:05] Running test: doc_deduplication
[0;32m[14:37:05] âœ“ Duplicate upload flagged (expected=true, actual=true)[0m
[0;32m[14:37:05] âœ“ doc_deduplication passed (0s)[0m
[14:37:05] Running test: doc_large_file_rejected
[0;32m[14:37:06] âœ“ Large file rejected[0m
[0;32m[14:37:06] âœ“ doc_large_file_rejected passed (1s)[0m
[14:37:06] Running test: doc_unsupported_type
[0;32m[14:37:06] âœ“ Unsupported mime rejected[0m
[0;32m[14:37:06] âœ“ doc_unsupported_type passed (0s)[0m
[14:37:06] Running test: doc_processing_speed_small
[0;32m[14:37:07] âœ“ 5-page PDF processed under 30s (9.546651 < 30)[0m
[0;32m[14:37:07] âœ“ doc_processing_speed_small passed (1s)[0m
[14:37:07] Running test: doc_processing_speed_large
[1;33m[14:37:07] âš  fpdf not available, creating minimal PDF instead[0m
[0;32m[14:37:07] âœ“ doc_processing_speed_large passed (0s)[0m
[14:37:07] Running test: doc_list_endpoint
[0;32m[14:37:07] âœ“ List documents endpoint[0m
[0;32m[14:37:07] âœ“ doc_list_endpoint passed (0s)[0m
[14:37:07] Running test: doc_detail_endpoint
[0;32m[14:37:07] âœ“ Document detail endpoint[0m
[0;32m[14:37:07] âœ“ doc_detail_endpoint passed (0s)[0m
[14:37:07] Running test: doc_chunks_endpoint
[0;32m[14:37:08] âœ“ Document chunks endpoint[0m
[0;32m[14:37:08] âœ“ doc_chunks_endpoint passed (1s)[0m
[14:37:08] Running test: doc_delete_endpoint
[0;32m[14:37:08] âœ“ Delete document endpoint[0m
[0;32m[14:37:08] âœ“ doc_delete_endpoint passed (0s)[0m
[14:37:08] Running test: doc_delete_vectors
[0;32m[14:37:09] âœ“ Vectors removed after delete (expected=0, actual=0)[0m
[0;32m[14:37:09] âœ“ doc_delete_vectors passed (1s)[0m
[14:37:09] Running test: doc_corrupted_pdf
[0;32m[14:37:10] âœ“ Corrupted PDF job failed (expected=failed, actual=failed)[0m
[0;32m[14:37:10] âœ“ doc_corrupted_pdf passed (1s)[0m
[14:37:10] Running test: doc_job_error
[0;32m[14:37:11] âœ“ Failed job error message populated[0m
[0;32m[14:37:11] âœ“ doc_job_error passed (1s)[0m
[14:37:11] Running test: doc_concurrent_uploads
[1;33m[14:37:11] âš  fpdf not available, creating minimal PDF instead[0m
[1;33m[14:37:11] âš  fpdf not available, creating minimal PDF instead[0m
[1;33m[14:37:11] âš  fpdf not available, creating minimal PDF instead[0m
[0;32m[14:37:11] âœ“ Concurrent uploads succeed (expected=0, actual=0)[0m
[0;32m[14:37:11] âœ“ doc_concurrent_uploads passed (0s)[0m
[14:37:11] Running test: doc_search_latency
* Host localhost:8000 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8000...
* Connected to localhost (::1) port 8000
* using HTTP/1.x
> GET /api/v1/search?q=document HTTP/1.1
> Host: localhost:8000
> User-Agent: curl/8.12.1
> Accept: */*
> Authorization: Bearer e1f8c9a2b3d4e5f6a7b8c9d0e1f2a3b4
> 
* Request completely sent off
< HTTP/1.1 200 OK
< date: Fri, 14 Nov 2025 14:37:11 GMT
< server: uvicorn
< content-length: 5563
< content-type: application/json
< 
* Connection #0 to host localhost left intact
* Host localhost:8000 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8000...
* Connected to localhost (::1) port 8000
* using HTTP/1.x
> GET /api/v1/search?q=document HTTP/1.1
> Host: localhost:8000
> User-Agent: curl/8.12.1
> Accept: */*
> Authorization: Bearer e1f8c9a2b3d4e5f6a7b8c9d0e1f2a3b4
> 
* Request completely sent off
< HTTP/1.1 200 OK
< date: Fri, 14 Nov 2025 14:37:11 GMT
< server: uvicorn
< content-length: 5563
< content-type: application/json
< 
* Connection #0 to host localhost left intact
* Host localhost:8000 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8000...
* Connected to localhost (::1) port 8000
* using HTTP/1.x
> GET /api/v1/search?q=document HTTP/1.1
> Host: localhost:8000
> User-Agent: curl/8.12.1
> Accept: */*
> Authorization: Bearer e1f8c9a2b3d4e5f6a7b8c9d0e1f2a3b4
> 
* Request completely sent off
< HTTP/1.1 200 OK
< date: Fri, 14 Nov 2025 14:37:12 GMT
< server: uvicorn
< content-length: 5563
< content-type: application/json
< 
* Connection #0 to host localhost left intact
* Host localhost:8000 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8000...
* Connected to localhost (::1) port 8000
* using HTTP/1.x
> GET /api/v1/search?q=document HTTP/1.1
> Host: localhost:8000
> User-Agent: curl/8.12.1
> Accept: */*
> Authorization: Bearer e1f8c9a2b3d4e5f6a7b8c9d0e1f2a3b4
> 
* Request completely sent off
< HTTP/1.1 200 OK
< date: Fri, 14 Nov 2025 14:37:12 GMT
< server: uvicorn
< content-length: 5563
< content-type: application/json
< 
* Connection #0 to host localhost left intact
* Host localhost:8000 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8000...
* Connected to localhost (::1) port 8000
* using HTTP/1.x
> GET /api/v1/search?q=document HTTP/1.1
> Host: localhost:8000
> User-Agent: curl/8.12.1
> Accept: */*
> Authorization: Bearer e1f8c9a2b3d4e5f6a7b8c9d0e1f2a3b4
> 
* Request completely sent off
< HTTP/1.1 200 OK
< date: Fri, 14 Nov 2025 14:37:12 GMT
< server: uvicorn
< content-length: 5563
< content-type: application/json
< 
* Connection #0 to host localhost left intact
[0;32m[14:37:13] âœ“ Search latency under threshold (186 < 200)[0m
[0;32m[14:37:13] âœ“ doc_search_latency passed (2s)[0m
[14:37:13] Running test: doc_metrics_counters
[0;32m[14:37:13] âœ“ documents_ingested_total metric defined (expected=1, actual=1)[0m
[0;32m[14:37:16] âœ“ rag_queries_total increments (2.0 > 1.0)[0m
[0;32m[14:37:16] âœ“ doc_metrics_counters passed (3s)[0m

======================================
STAGE 4: BACKUPS + RETENTION + OBSERVABILITY
======================================

[14:37:16] Running test: stage4_metrics_defined
[0;32m[14:37:16] âœ“ stage4_metrics_defined passed (0s)[0m
[14:37:16] Running test: stage4_metrics_non_zero
[0;32m[14:37:22] âœ“ Notes created metric non-zero[0m
[0;32m[14:37:22] âœ“ stage4_metrics_non_zero passed (6s)[0m
[14:37:22] Running test: stage4_metrics_histograms
[0;32m[14:37:22] âœ“ Reminder fire lag histogram exported[0m
[0;32m[14:37:22] âœ“ stage4_metrics_histograms passed (0s)[0m
[14:37:22] Running test: stage4_metrics_gauges
[0;32m[14:37:22] âœ“ stage4_metrics_gauges passed (0s)[0m
[14:37:22] Running test: stage4_metrics_counters
[0;32m[14:37:28] âœ“ API request counter increments[0m
[0;32m[14:37:28] âœ“ stage4_metrics_counters passed (6s)[0m
[14:37:28] Running test: stage4_slo_reminder
[1;33m[14:37:28] âš  Reminder lag metric lacks samples[0m
[0;32m[14:37:28] âœ“ stage4_slo_reminder passed (0s)[0m
[14:37:28] Running test: stage4_slo_push
[1;33m[14:37:29] âš  Push success rate unavailable[0m
[0;32m[14:37:29] âœ“ stage4_slo_push passed (1s)[0m
[14:37:29] Running test: stage4_slo_document
[1;33m[14:37:29] âš  Document ingestion histogram empty[0m
[0;32m[14:37:29] âœ“ stage4_slo_document passed (0s)[0m
[14:37:29] Running test: stage4_slo_vector
[0;32m[14:37:29] âœ“ Vector search p95 under threshold (186 < 200)[0m
[0;32m[14:37:29] âœ“ stage4_slo_vector passed (0s)[0m
[14:37:29] Running test: stage4_backup_script
[0;32m[14:37:29] âœ“ Backup script present[0m
[0;32m[14:37:29] âœ“ stage4_backup_script passed (0s)[0m
[14:37:29] Running test: stage4_backup_run
[0;32m[14:37:37] âœ“ Backup timestamp recorded[0m
[0;32m[14:37:37] âœ“ stage4_backup_run passed (8s)[0m
[14:37:38] Running test: stage4_backup_postgres
[0;32m[14:37:38] âœ“ Postgres dump created[0m
[0;32m[14:37:38] âœ“ stage4_backup_postgres passed (0s)[0m
[14:37:38] Running test: stage4_backup_qdrant
[0;32m[14:37:38] âœ“ Qdrant snapshot created[0m
[0;32m[14:37:38] âœ“ stage4_backup_qdrant passed (0s)[0m
[14:37:38] Running test: stage4_backup_files
[0;32m[14:37:38] âœ“ Vault archive present[0m
[0;32m[14:37:38] âœ“ Uploads archive present[0m
[0;32m[14:37:38] âœ“ stage4_backup_files passed (0s)[0m
[14:37:38] Running test: stage4_backup_manifest
[0;32m[14:37:38] âœ“ Backup manifest present[0m
[0;32m[14:37:38] âœ“ Manifest references timestamp[0m
[0;32m[14:37:38] âœ“ stage4_backup_manifest passed (0s)[0m
[14:37:38] Running test: stage4_restore_script
[0;32m[14:37:38] âœ“ Restore script present[0m
[0;32m[14:37:38] âœ“ stage4_restore_script passed (0s)[0m
[14:37:38] Running test: stage4_restore_temp_db
[0;32m[14:38:02] âœ“ Temp database restored (expected=1, actual=1)[0m
[0;32m[14:38:03] âœ“ stage4_restore_temp_db passed (24s)[0m
[14:38:03] Running test: stage4_retention_scheduler
[0;32m[14:38:03] âœ“ Celery beat running[0m
[0;32m[14:38:03] âœ“ stage4_retention_scheduler passed (0s)[0m
[14:38:03] Running test: stage4_retention_cleanup
[0;32m[14:38:12] âœ“ Retention cleanup task invoked[0m
[0;32m[14:38:12] âœ“ stage4_retention_cleanup passed (9s)[0m
[14:38:12] Running test: stage4_retention_metrics
[0;32m[14:38:12] âœ“ Retention cleanup metric reports work (1 > 0)[0m
[0;32m[14:38:12] âœ“ stage4_retention_metrics passed (0s)[0m
[14:38:12] Running test: stage4_db_size
[0;32m[14:38:13] âœ“ DB size script runs[0m
[0;32m[14:38:14] âœ“ stage4_db_size passed (1s)[0m
[14:38:14] Running test: stage4_db_vacuum
[0;32m[14:38:14] âœ“ VACUUM completed[0m
[0;32m[14:38:14] âœ“ stage4_db_vacuum passed (0s)[0m
[14:38:14] Running test: stage4_metrics_prom
[0;32m[14:38:14] âœ“ Metrics endpoint in Prometheus format[0m
[0;32m[14:38:14] âœ“ stage4_metrics_prom passed (0s)[0m
[14:38:14] Running test: stage4_manifest_counts
[0;32m[14:38:14] âœ“ Manifest lists artifacts (3 > 0)[0m
[0;32m[14:38:14] âœ“ stage4_manifest_counts passed (0s)[0m

======================================
STAGE 5: MOBILE + IDEMPOTENCY
======================================

[14:38:14] Running test: stage5_idempotency_table
[14:38:14] Checking idempotency_keys table exists...
[0;32m[14:38:15] âœ“ idempotency_keys table exists (expected=1, actual=1)[0m
[0;32m[14:38:15] âœ“ stage5_idempotency_table passed (1s)[0m
[14:38:15] Running test: stage5_idempotency_create
[14:38:15] Testing idempotency key with reminder creation...
[14:38:15] Creating reminder with idempotency key: test-idem-20251114-172727-15554
[0;32m[14:38:16] âœ“ Reminder ID returned[0m
[0;32m[14:38:16] âœ“ Idempotency key stored in database (expected=1, actual=1)[0m
[0;32m[14:38:16] âœ“ stage5_idempotency_create passed (1s)[0m
[14:38:16] Running test: stage5_idempotency_duplicate
[14:38:16] Testing duplicate prevention with same idempotency key...
[14:38:16] First request with key: test-dup-20251114-172727-3849
[0;32m[14:38:17] âœ“ First response includes reminder ID[0m
[14:38:17] Second request with same key: test-dup-20251114-172727-3849
[0;32m[14:38:17] âœ“ Second response includes reminder ID[0m
[0;32m[14:38:17] âœ“ X-Idempotency-Replay header present: x-idempotency-replay: true[0m
[0;32m[14:38:18] âœ“ Only one reminder created despite duplicate request (expected=1, actual=1)[0m
[0;32m[14:38:18] âœ“ stage5_idempotency_duplicate passed (2s)[0m
[14:38:18] Running test: stage5_idempotency_header
[14:38:18] Testing idempotency replay header...
[0;32m[14:38:18] âœ“ X-Idempotency-Replay header found in response[0m
[0;32m[14:38:18] âœ“ stage5_idempotency_header passed (0s)[0m
[14:38:18] Running test: stage5_idempotency_aggressive
[14:38:18] Testing aggressive retry scenario (10 rapid requests with same key)...
[14:38:19] Sending 10 parallel requests with same idempotency key...
[14:38:21] Checking database for duplicate reminders...
[0;32m[14:38:22] âœ“ Aggressive retry test passed: only 1 reminder created from 10 concurrent requests[0m
[0;32m[14:38:22] âœ“ stage5_idempotency_aggressive passed (4s)[0m
[14:38:22] Running test: stage5_idempotency_different_key
[14:38:22] Testing that different idempotency keys create separate reminders...
[14:38:22] Creating reminder with key1: test-key1-20251114-172727-6644
[14:38:22] Creating reminder with key2: test-key2-20251114-172727-4032
[0;31m[14:38:23] âœ— Same reminder ID returned for different idempotency keys! id=dfb22283-b969-481a-aa3d-4f2800c8cabb[0m
[0;31m[14:38:23] âœ— stage5_idempotency_different_key failed[0m
