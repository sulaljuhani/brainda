
======================================
SETUP
======================================

[14:42:49] Using base URL: http://localhost:8000
[14:42:49] Waiting for: orchestrator health endpoint (timeout 60s)
[0;32m[14:42:54] âœ“ Condition met after 0s[0m
[0;32m[14:42:59] âœ“ Health endpoint reports healthy (expected=healthy, actual=healthy)[0m

======================================
STAGE 8: PASSKEYS + MULTI-USER
======================================

[14:42:59] Running test: stage8_org_table
[14:42:59] Validating organizations schema
[0;32m[14:43:00] âœ“ Table 'organizations' exists (expected=1, actual=1)[0m
[0;32m[14:43:01] âœ“ Column organizations.id exists (expected=1, actual=1)[0m
[0;32m[14:43:01] âœ“ Column organizations.name exists (expected=1, actual=1)[0m
[0;32m[14:43:02] âœ“ Column organizations.created_at exists (expected=1, actual=1)[0m
[0;32m[14:43:02] âœ“ stage8_org_table passed (3s)[0m
[14:43:02] Running test: stage8_passkey_table
[14:43:02] Validating passkey credential schema
[0;32m[14:43:03] âœ“ Table 'passkey_credentials' exists (expected=1, actual=1)[0m
[0;32m[14:43:03] âœ“ Column passkey_credentials.user_id exists (expected=1, actual=1)[0m
[0;32m[14:43:04] âœ“ Column passkey_credentials.credential_id exists (expected=1, actual=1)[0m
[0;32m[14:43:05] âœ“ Column passkey_credentials.public_key exists (expected=1, actual=1)[0m
[0;32m[14:43:05] âœ“ Column passkey_credentials.counter exists (expected=1, actual=1)[0m
[0;32m[14:43:06] âœ“ Foreign key passkey_credentials.user_id references users (expected=1, actual=1)[0m
[0;32m[14:43:06] âœ“ stage8_passkey_table passed (4s)[0m
[14:43:06] Running test: stage8_totp_table
[14:43:06] Validating TOTP secret storage
[0;32m[14:43:07] âœ“ Table 'totp_secrets' exists (expected=1, actual=1)[0m
[0;32m[14:43:07] âœ“ Column totp_secrets.user_id exists (expected=1, actual=1)[0m
[0;32m[14:43:08] âœ“ Column totp_secrets.secret exists (expected=1, actual=1)[0m
[0;32m[14:43:09] âœ“ Column totp_secrets.backup_codes exists (expected=1, actual=1)[0m
[0;32m[14:43:09] âœ“ Column totp_secrets.enabled exists (expected=1, actual=1)[0m
[0;32m[14:43:10] âœ“ Foreign key totp_secrets.user_id references users (expected=1, actual=1)[0m
[0;32m[14:43:10] âœ“ stage8_totp_table passed (4s)[0m
[14:43:10] Running test: stage8_sessions_table
[14:43:10] Validating sessions schema
[0;32m[14:43:11] âœ“ Table 'sessions' exists (expected=1, actual=1)[0m
[0;32m[14:43:11] âœ“ Column sessions.token exists (expected=1, actual=1)[0m
[0;32m[14:43:12] âœ“ Column sessions.user_id exists (expected=1, actual=1)[0m
[0;32m[14:43:13] âœ“ Column sessions.device_type exists (expected=1, actual=1)[0m
[0;32m[14:43:13] âœ“ Column sessions.expires_at exists (expected=1, actual=1)[0m
[0;32m[14:43:14] âœ“ Column sessions.created_at exists (expected=1, actual=1)[0m
[0;32m[14:43:15] âœ“ Foreign key sessions.user_id references users (expected=1, actual=1)[0m
[0;32m[14:43:15] âœ“ stage8_sessions_table passed (5s)[0m
[14:43:15] Running test: stage8_multi_user
[14:43:15] Validating multi-tenant relationships
[0;32m[14:43:15] âœ“ Column users.organization_id exists (expected=1, actual=1)[0m
[0;32m[14:43:16] âœ“ Foreign key users.organization_id references organizations (expected=1, actual=1)[0m
[0;32m[14:43:16] âœ“ stage8_multi_user passed (1s)[0m
[14:43:16] Running test: stage8_user_isolation
[14:43:16] Checking user ownership constraints on core tables
[0;32m[14:43:17] âœ“ Column notes.user_id exists (expected=1, actual=1)[0m
[0;32m[14:43:17] âœ“ Foreign key notes.user_id references users (expected=1, actual=1)[0m
[0;32m[14:43:18] âœ“ Column reminders.user_id exists (expected=1, actual=1)[0m
[0;32m[14:43:19] âœ“ Foreign key reminders.user_id references users (expected=1, actual=1)[0m
[0;32m[14:43:19] âœ“ Column calendar_events.user_id exists (expected=1, actual=1)[0m
[0;32m[14:43:20] âœ“ Foreign key calendar_events.user_id references users (expected=1, actual=1)[0m
[0;32m[14:43:21] âœ“ Column documents.user_id exists (expected=1, actual=1)[0m
[0;32m[14:43:21] âœ“ Foreign key documents.user_id references users (expected=1, actual=1)[0m
[0;32m[14:43:21] âœ“ stage8_user_isolation passed (5s)[0m
[14:43:21] Running test: stage8_totp_flow
[14:43:21] Exercising TOTP setup and verification endpoints
[0;32m[14:43:22] âœ“ Resolved test user from API token[0m
[14:43:22] Ensuring TOTP secret is configured and verified
[0;32m[14:43:24] âœ“ TOTP setup endpoint available (expected=200, actual=200)[0m
[0;32m[14:43:25] âœ“ Received TOTP secret[0m
[0;32m[14:43:25] âœ“ Generated current TOTP code[0m
[0;32m[14:43:25] âœ“ TOTP verify endpoint succeeded (expected=200, actual=200)[0m
[0;32m[14:43:25] âœ“ TOTP verification accepted code (expected=true, actual=true)[0m
[0;32m[14:43:26] âœ“ TOTP secret marked enabled in database (expected=t, actual=t)[0m
[0;32m[14:43:26] âœ“ TOTP setup + verification completed[0m
[0;32m[14:43:26] âœ“ stage8_totp_flow passed (5s)[0m
[14:43:26] Running test: stage8_session_endpoints
[14:43:26] Testing session creation via TOTP and logout invalidation
[14:43:26] Ensuring TOTP secret is configured and verified
[0;32m[14:43:28] âœ“ TOTP setup endpoint available (expected=200, actual=200)[0m
[0;32m[14:43:28] âœ“ Received TOTP secret[0m
[0;32m[14:43:28] âœ“ Generated current TOTP code[0m
[0;32m[14:43:28] âœ“ TOTP verify endpoint succeeded (expected=200, actual=200)[0m
[0;32m[14:43:28] âœ“ TOTP verification accepted code (expected=true, actual=true)[0m
[0;32m[14:43:29] âœ“ TOTP secret marked enabled in database (expected=t, actual=t)[0m
[0;32m[14:43:29] âœ“ Generated TOTP code for authentication[0m
[0;32m[14:43:29] âœ“ TOTP authenticate endpoint returned 200 (expected=200, actual=200)[0m
[0;32m[14:43:30] âœ“ Received session token[0m
[0;31m[14:43:30] âœ— Session persisted in database (expected=1, actual=0)[0m
[0;32m[14:43:30] âœ“ Logout endpoint invalidated session (expected=200, actual=200)[0m
[0;32m[14:43:31] âœ“ Session removed after logout (expected=0, actual=0)[0m
[0;32m[14:43:31] âœ“ stage8_session_endpoints passed (5s)[0m
[14:43:31] Running test: stage8_auth_audit
[14:43:31] Validating auth audit log schema
[0;32m[14:43:32] âœ“ Table 'auth_audit_log' exists (expected=1, actual=1)[0m
[0;32m[14:43:32] âœ“ Column auth_audit_log.user_id exists (expected=1, actual=1)[0m
[0;32m[14:43:33] âœ“ Column auth_audit_log.event_type exists (expected=1, actual=1)[0m
[0;32m[14:43:34] âœ“ Column auth_audit_log.created_at exists (expected=1, actual=1)[0m
[0;32m[14:43:34] âœ“ stage8_auth_audit passed (3s)[0m

======================================
TEST SUMMARY
======================================

Total Tests: 9
Passed: 9
Failed: 0
Warnings: 0
Duration: 0m 46s
Pass Rate: 100.0%

SLO Status:
  - Reminder fire lag p95: unavailable
  - Push success rate: unavailable
  - Document ingestion p95: unavailable
  - Vector search p95: unavailable

Logs: /tmp/vib-test-20251114-174248/run.log
Artifacts: /tmp/vib-test-20251114-174248
[14:43:34] JSON report: /tmp/vib-test-20251114-174248/results.json
[14:43:34] Cleaning up test data...
[0;32m[14:43:37] âœ“ Cleanup complete[0m
